<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html">
<link rel="import" href="../at-carbon-tabs/at-carbon-tab.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-form-behaviors/at-form-behaviors.html">
<link rel="import" href="../at-core-style-classes/at-core-style-classes.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="at-form-tabs-input-validation-behavior.html">

<dom-module id="at-form-tabs">
  <template>
    <style include="at-form-common">
      :host {
        display: block;
        box-sizing: border-box;
      }

      :host([hidden]) {
        display: none !important;
      }

      :host[hidden] {
        display: none !important;
      }

      #tabsContainer {
        height: 100%;
      }

      at-carbon-tab {
        border-bottom: 2px solid transparent;
        padding-bottom: 12px;
      }

      at-carbon-tab[disabled] {
        pointer-events: none;
      }

      at-carbon-tab.selected {
        border-bottom: 2px solid var(--primary-color);
      }

      /*
        STYLES for the tab-style tab
      */

      :host([tab-style="tab"]) at-carbon-tab {
        position: relative;
        margin: 0 auto;
        padding: 12px;

        border-bottom: 1px solid lightgray;
      }

      :host([tab-style="tab"]) at-carbon-tab.selected {
        border-bottom: 2px solid var(--primary-color);

        background-image: linear-gradient(transparent 10%, var(--at-light-blue));
      }

      :host([tab-style="tab"]) at-carbon-tab:before, 
      :host([tab-style="tab"]) at-carbon-tab:after {
        content: "";
        position: absolute;

        top: -1px;
        bottom: -1px;

        width: 1px;
        background-image: linear-gradient(transparent 30%, lightgray 100%);
      }

      :host([tab-style="tab"]) at-carbon-tab:before {
        left: -1px;
      }

      :host([tab-style="tab"]) at-carbon-tab:after {
        right: 0px;
      }


      /*
        COMPACT TAB styles
      */
      :host([tab-style="tab"][size="compact"]) at-carbon-tab at-carbon-icon {
        display: none !important;
      }

      :host([tab-style="tab"][size="compact"]) at-carbon-tab:hover label {
        color: var(--primary-color);
      }

      :host([tab-style="tab"][size="compact"]) at-carbon-tab:focus {
        outline: none;
        background-image: linear-gradient(transparent 10%, var(--at-light-blue));
      }

      :host([tab-style="tab"][size="compact"]) at-carbon-tab:focus label {
        color: var(--primary-color);
      }

      /*
        LARGE TAB styles
      */
      :host([tab-style="tab"][size="large"]) at-carbon-tab at-carbon-icon {
        display: block !important;
        margin: 0 auto;
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab label {
        display: block !important;
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab.selected at-carbon-icon {
        color: var(--primary-color);
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab.selected label {
        color: var(--primary-color);
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab:hover at-carbon-icon {
        color: var(--primary-color);
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab:hover label {
        color: var(--primary-color);
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab:focus {
        outline: none;
        background-image: linear-gradient(transparent 10%, var(--at-light-blue));
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab:focus at-carbon-icon {
        color: var(--primary-color);
      }

      :host([tab-style="tab"][size="large"]) at-carbon-tab:focus label {
        color: var(--primary-color);
      }

      /*
        STYLES for the tab-style pill
      */

      :host([tab-style="pill"]) at-carbon-tab {
        position: relative;
        margin: 0 auto;
        padding: 12px;
      
        border: 1px solid lightgray;
      }

      :host([tab-style="pill"]) at-carbon-tab.selected {
        color: var(--primary-color) !important;
        background-color: var(--at-light-blue) !important;
      }
      
      /*
        PILL COMPACT styles
      */
      
      :host([tab-style="pill"][size="compact"]) at-carbon-tab at-carbon-icon {
        display: none !important;
      }

      :host([tab-style="pill"][size="compact"]) at-carbon-tab:hover {
        background-color: var(--at-light-grey);
      }

      :host([tab-style="pill"][size="compact"]) at-carbon-tab:hover label {
        color: var(--at-black);
      }

      :host([tab-style="pill"][size="compact"]) at-carbon-tab:focus {
        outline: none;
        background-color: var(--at-light-grey);
      }

      :host([tab-style="pill"][size="compact"]) at-carbon-tab:focus label {
        color: var(--primary-color);
      }
      
      /*
        PILL LARGE styles
      */

      :host([tab-style="pill"][size="large"]) at-carbon-tab at-carbon-icon {
        display: block !important;
        margin: 0 auto;
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab label {
        display: block !important;
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab.selected at-carbon-icon {
        color: var(--primary-color);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab.selected label {
        color: var(--primary-color);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab:hover {
        background-color: var(--at-light-grey);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab:hover at-carbon-icon {
        color: var(--at-black);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab:hover label {
        color: var(--at-black);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab:focus {
        outline: none;
        background-color: var(--at-light-grey);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab:focus at-carbon-icon {
        color: var(--primary-color);
      }

      :host([tab-style="pill"][size="large"]) at-carbon-tab:focus label {
        color: var(--primary-color);
      }

    </style>
    <div id="atContainer" class="at-container">
      <iron-label hidden$="[[hideLabel]]" id="label" for="input">{{label}}</iron-label>
      <div id="contentContainer" class="at-content-container">
        <div id="tabsContainer" class="layout-horizontal layout-start-justified" on-click="_handleTabClick">at-form-tabs works!</div>
      </div>
      <div id="hint"></div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: "at-form-tabs",
    behaviors: [Tangere.behaviors.i18n, Tangere.behaviors.formUIGeneric, Tangere.behaviors.AtFormTabsInputValidation],
    properties: {
      /**
       * Element's label for element display purposes
       * @property label
       * @type String
       * @default ""
       */
       label: {
        type: String,
        value: '',
        title: 'Label'
      },

      /**
       * When true label is hidden
       * @property hideLabel
       * @type Boolean
       * @default false
       */
      hideLabel: {
        type: Boolean,
        value: false,
        title: 'Do not show the label'
      },

      /**
       * Element's disabled state
       * @property disabled
       * @type Boolean
       * @default false
       */
      disabled: {
        type: Boolean,
        value: false,
        observer: '_disabledChanged',
        title: 'Field value can not be changed'
      },

      /**
       * Hides the element. When hidden nothing is displayed for the element
       * @property hide
       * @type Boolean
       * @default false
       */
      hide: {
        type: Boolean,
        value: false,
        observer: '_hideChanged',
        title: 'Field is invisible'
      },

      /**
       * Element's required state for element validation purposes
       * @property required
       * @type Boolean
       * @default false
       */
      required: {
        type: Boolean,
        value: false,
        title: 'Input required'
      },

      xvaluelist: {
        type: Array,
        value: function() {
          return [];
        },
        observer: "_xvaluelistChanged",
        schema: {
          items: {
            type: "object",
            properties: {
              value: {
                type: "string",
                title: "Value"
              },
              title: {
                type: "string",
                title: "Title"
              },
              disabled: {
                type: "boolean",
                title: "Disabled"
              },
              badgeLabel: {
                type: "string",
                title: "Badge Label"
              },
              badgeColor: {
                type: "string",
                title: "Badge Color"
              }
            }
          }
        },
        title: "Tabs",
        xgridcols: "12"
      },

      value: {
        type: String,
        value: "",
        observer: "_valueChanged"
      },

      position: {
        type: String,
        value: "left",
        observer: "_positionChagned",
        xvaluelist: [
          { title: "Left", value: "left" },
          { title: "Center", value: "center" },
          { title: "Right", value: "right" }
        ],
        xtype: "enum",
      },

      tabStyle: {
        type: String,
        value: "default",
        observer: "_positionChagned",
        xvaluelist: [
          { title: "Default", value: "default" },
          { title: "Tab", value: "tab" },
          { title: "Pill", value: "pill" }
        ],
        xtype: "enum"
      },

      size: {
        type: String,
        value: "compact",
        observer: "_positionChagned",
        xvaluelist: [
          { title: "Compact", value: "compact" },
          { title: "Large", value: "large" }
        ],
        xtype: "enum"
      },
    },

    observers: [
      '_internalValidStateUpdate(required)'
    ],

    $meta: [{
      title: "Tabs",
      type: "element",
      xtype: "at-form-tabs",
      events: ["value-changed"],
      icon: "now:wrench"
    }],

    _disabledChanged: function(newValue, oldValue) {
      this.toggleAttribute('disabled', newValue, this);
      
      var container = this.$.atContainer;
      this.toggleClass('disabled', newValue, container);
    },

    _hideChanged: function(newValue, oldValue) {
      this.toggleAttribute('hidden', newValue, this);
    },

    ready: function() {
      this._isReady = true;
      this._internalValidStateUpdate(this.required);
    },

    _internalValidStateUpdate: function(required) {
      if (!this._isReady) return;
        
      if (this._showErrorsWhenAttached) {
        this._showErrorsWhenAttached = undefined;
        this.validate(true);
        return;
      
      } else if (this._clearErrorsWhenAttached) {
        this._clearErrorsWhenAttached = undefined;
        this.validate(false);
        return;
      }

      this.validate();
    },

    _xvaluelistChanged: function(newValue, oldValue) {

      if (this._isString(newValue)) {
        try {
          this.xvaluelist = JSON.parse(newValue);
        } catch (e) {
          console.log(e);
        }
        return;
      }

      if (!this._isArray(newValue)) return;
      
      // clear previous data if there are no slotted items 
      Polymer.dom(this.$.tabsContainer).innerHTML = "";

      if (newValue.length == 0) return;

      var self = this;
      newValue.forEach(function(tabDef) {
        var formTab = self.create('at-carbon-tab');
      formTab.badgeLabel = tabDef.badgeLabel;
        formTab.badgeColor = tabDef.badgeColor;
        
        if (tabDef.icon != undefined) {
          var iconElt = self.create('at-carbon-icon');
          iconElt.icon = tabDef.icon;
          Polymer.dom(formTab).appendChild(iconElt);

          var labelElt = self.create('label');
          labelElt.textContent = tabDef.title;
          Polymer.dom(formTab).appendChild(labelElt);

        } else {
          formTab.label = tabDef.title;
        }
        
        
        Polymer.dom(formTab).classList.add('font-body1');
        self.toggleClass('selected', tabDef.value == self.value, formTab);
        formTab.setAttribute('id', tabDef.value);
        self.toggleAttribute('disabled', tabDef.disabled, formTab);

        Polymer.dom(self.$.tabsContainer).appendChild(formTab);
      });

      this.selected = newValue[0].value;
    },

    _valueChanged: function(newValue, oldValue) {
      this._selectTab(newValue);
      
      if (this._isReady) {
        this._fireValueChangedEvent(this.value);
      }

      // show validation result when autoValidate is enabled
      if(this.autoValidate) this._validate(true);
    },

    validate: function (showError) {
      if (!this.$ && this.autoValidate == false && showError == true) {
        // showError should be true when _internalValidStateUpdate is called from ready after element is attached
        this._showErrorsWhenAttached = true;

      } else if (!this.$ && this.autoValidate == true && showError == false) {
        this._clearErrorsWhenAttached = true;
      }

      if(showError === undefined) showError = this.autoValidate;

      return this._validate(showError);

    },

    _validate: function(showError) {

      var validationResult = this._validateBaseData();
      this._handleValidationResult(validationResult);
      if (!validationResult.isValid) {
        return validationResult.isValid;
      }

      validationResult = this._validateData(this, this.value, this.T.bind(this));
      if(showError) this._handleValidationResult(validationResult);

      return validationResult.isValid;
    },

    _updateUIValidState: function (isValid) {
      if (!this.$) return;

      var label = this.$.label;
      this.toggleClass('error', !isValid, label);
      var contentContainer = this.$.contentContainer;
      this.toggleClass('error', !isValid, contentContainer);
    },

    _findCarbonTabInPath: function(event) {
      if (event.target.id == "tabsContainer") return event.target;

      var path = Polymer.dom(event).path;
      
      var index = 0;
      var result = path[index];
      
      while(index < path.length && result.is != "at-carbon-tab") {
        index += 1;
        result = path[index];
      }

      return result;
    },

    _handleTabClick: function(event) {
      var tab = this._findCarbonTabInPath(event);
      if (tab.is != "at-carbon-tab") return;

      this._selectTab(tab.id);

      this.value = tab.id;
      this.fire('value-changed', { value: this.value }, { bubbles: false });
    },

    _selectTab: function(id) {
      var current = Polymer.dom(this.$.tabsContainer).querySelector('.selected');
      if (current) {
        Polymer.dom(current).classList.remove('selected');
      }

      if (!this._isString(id) || id.length == 0) return;

      var selector = '#'+id;
      current = Polymer.dom(this.$.tabsContainer).querySelector(selector);
      if (!current) return;

      var disabled = current.getAttribute('disabled');
      if (disabled || disabled == "") return;
      
      Polymer.dom(current).classList.add('selected');
    },

    _positionChagned: function(newValue, oldValue) {
      this.toggleClass("layout-start-justified", newValue == "left", this.$.tabsContainer);
      this.toggleClass("layout-center-justified", newValue == "center", this.$.tabsContainer);
      this.toggleClass("layout-end-justified", newValue == "right", this.$.tabsContainer);
    },

    _isString: function(obj) { return Object.prototype.toString.call(obj) === "[object String]"; },

    _isArray: function(obj) { return Object.prototype.toString.call(obj) === "[object Array]"; }

  });
</script>
